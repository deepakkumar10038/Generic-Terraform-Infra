trigger:
  branches:
    include:
    - main
    - feature/*

pr:
  branches:
    include:
    - main

pool:
  name: default

variables:
- name: work_dir
  value: '$(System.DefaultWorkingDirectory)/env/dev'

stages:

# =================================================
# PLAN STAGE (Feature Push + PR + Main)
# =================================================
- stage: Terraform_Plan
  displayName: "Terraform Plan"
  jobs:
  - job: plan
    displayName: "Terraform Plan Job"
    steps:
    - task: TerraformInstaller@1
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: 'latest'

    - task: TerraformTask@5
      displayName: 'Terraform Init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(work_dir)'
        backendServiceArm: 'Deepak_serviceconnection'
        backendAzureRmStorageAccountName: 'deep57stg'
        backendAzureRmContainerName: 'deepcnt'
        backendAzureRmKey: 'prod/terraform.tfstate'

    - task: TerraformTask@5
      displayName: 'Terraform Validate'
      inputs:
        provider: 'azurerm'
        command: 'validate'
        workingDirectory: '$(work_dir)'

    - task: TerraformTask@5
      displayName: 'Terraform Fmt'
      inputs:
        provider: 'azurerm'
        command: 'custom'
        customCommand: 'fmt'
        workingDirectory: '$(work_dir)'

    - task: TerraformTask@5
      displayName: 'Terraform Plan'
      inputs:
        provider: 'azurerm'
        command: 'plan'
        workingDirectory: '$(work_dir)'
        environmentServiceNameAzureRM: 'Deepak_serviceconnection'


# =================================================
# APPLY STAGE (ONLY MAIN BRANCH)
# =================================================
- stage: Terraform_Apply
  displayName: "Terraform Apply"
  dependsOn: Terraform_Plan
  condition: |
    and(
      succeeded(),
      eq(variables['Build.SourceBranch'], 'refs/heads/main'),
      ne(variables['Build.Reason'], 'PullRequest')
    )

  jobs:
  - deployment: apply
    displayName: "Apply with Approval"
    environment: terraform-prod   # ðŸ‘ˆ reviewer approval here
    strategy:
      runOnce:
        deploy:
          steps:

          - task: ManualValidation@0
            displayName: "Manual Approval Before Apply"
            inputs:
              instructions: |
                Review terraform plan output.
                Approve to proceed with terraform apply.
              timeoutInMinutes: 1440

          - task: TerraformTask@5
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(work_dir)'
              environmentServiceNameAzureRM: 'Deepak_serviceconnection'
